<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Hoja de pesos y sebo 2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

  <style>
    body { font-family: sans-serif; background:#f2f2f2; padding:30px; }
    .container { background:#fff; padding:40px; border-radius:12px; max-width:900px; margin:auto; }
    h1 { margin:0 0 12px; font-size:32px; }
    label { display:block; margin-top:18px; font-weight:700; }
    input, textarea {
      width:100%; padding:10px; font-size:16px; margin-top:6px;
      border:1px solid #d1d5db; border-radius:10px;
    }
    textarea { min-height:120px; resize:vertical; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-top:14px; }
    .row > div { flex:1 1 220px; }
    button {
      padding:12px 18px; border:none; border-radius:10px;
      background:#198754; color:#fff; font-size:16px; cursor:pointer;
    }
    button:hover { background:#146c43; }
    .btn-gray{ background:#374151; }
    .btn-gray:hover{ background:#111827; }
    .btn-teal{ background:#0f766e; }
    .btn-teal:hover{ background:#115e59; }
    .btn-red{ background:#dc2626; }
    .btn-red:hover{ background:#b91c1c; }

    #resultado-totales{
      margin-top:22px; white-space:pre-line; font-size:16px;
      background:#f9fafb; border:1px solid #e5e7eb; padding:14px; border-radius:12px;
    }
    .hr{ margin:26px 0; border-top:1px solid #e5e7eb; }
    .hint{ color:#6b7280; font-size:13px; margin-top:6px; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; }
    th, td{ border:1px solid #e5e7eb; padding:8px; text-align:left; }
    th{ background:#f9fafb; }
    .mini{ font-size:12px; color:#6b7280; }
    .msgbox{
      margin-top:12px; white-space:pre-line; background:#0b1220; color:#e5e7eb;
      padding:14px; border-radius:12px; border:1px solid #111827;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>Hoja de pesos y sebo</h1>

    <label for="fecha">Fecha del viaje:</label>
    <input type="date" id="fecha" />

    <div class="row">
      <div style="flex:0 0 auto;">
        <button onclick="guardarViaje()">Guardar Viaje</button>
      </div>
      <div style="flex:0 0 auto;">
        <button class="btn-gray" onclick="generarDocumento()">Generar Documento de Totales</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- SEBO -->
    <h2 style="margin:0;">Papel de sebo 80mm</h2>
    <div class="row">
      <div>
        <label for="seboKg">Kilos de sebo (DIO SEBO):</label>
        <input type="number" id="seboKg" step="0.01" min="0" placeholder="Ej. 15.00" />
      </div>
      <div style="flex:0 0 auto;">
        <button onclick="imprimirSebo80mm()">Imprimir papel de sebo 80mm</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- ETIQUETA LIBRE -->
    <h2 style="margin:0;">Etiqueta libre 80mm</h2>
    <div class="hint">Escribe el texto como quieras (con saltos de l√≠nea). Ej: ‚ÄúCAJA WASHINGTON‚Üµ890 kg‚Üµ40 cajas‚Äù.</div>

    <label for="etiquetaTexto">Texto de etiqueta:</label>
    <textarea id="etiquetaTexto" placeholder="CAJA WASHINGTON
890 kg
40 cajas"></textarea>

    <div class="row">
      <div>
        <label for="etqCopias">Copias:</label>
        <input type="number" id="etqCopias" min="1" step="1" value="1" />
      </div>
      <div style="flex:0 0 auto;">
        <button onclick="imprimirEtiqueta80mm()">Imprimir etiqueta 80mm</button>
      </div>
      <div style="flex:0 0 auto;">
        <button class="btn-gray" onclick="limpiarEtiqueta()">Limpiar</button>
      </div>
    </div>

    <div class="hr"></div>

    <!-- === MENSAJE LIBRE PARA WHATSAPP === -->
    <h2 style="margin:0;">Mensaje de pesajes para WhatsApp</h2>
    <div class="hint">Aqu√≠ registras lo recibido (sucio/limpio, etc.) y generas el mensaje listo para enviar.</div>

    <div class="row">
      <div>
        <label for="origen">Origen / De qui√©n se recibe:</label>
        <input id="origen" placeholder="Ej. Rastro municipal / Mireles / Botello / Viaje / Limpieza" />
      </div>
      <div>
        <label for="whatsNumero">WhatsApp destino (opcional):</label>
        <input id="whatsNumero" placeholder="Ej. 524621872594 (sin + ni espacios)" />
        <div class="mini">Si lo dejas vac√≠o, igual genera el texto y t√∫ lo pegas donde quieras.</div>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="prodNombre">Producto:</label>
        <input id="prodNombre" placeholder="Ej. Panza sucia / Libro limpio / Menudo sucio / Cabeza de res" />
      </div>
      <div>
        <label for="prodKg">Kg (opcional):</label>
        <input type="number" id="prodKg" step="0.01" min="0" placeholder="Ej. 130" />
      </div>
      <div>
        <label for="prodPzas">Pzas (opcional):</label>
        <input type="number" id="prodPzas" step="1" min="0" placeholder="Ej. 20" />
      </div>
      <div style="flex:0 0 auto;">
        <button onclick="agregarLinea()">Agregar</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Producto</th>
          <th>Kg</th>
          <th>Pzas</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="tablaLineas"></tbody>
    </table>

    <div class="row">
      <div style="flex:0 0 auto;">
        <button class="btn-teal" onclick="generarMensaje()">Generar mensaje</button>
      </div>
      <div style="flex:0 0 auto;">
        <button onclick="copiarMensaje()">Copiar</button>
      </div>
      <div style="flex:0 0 auto;">
        <button class="btn-gray" onclick="abrirWhatsApp()">Abrir WhatsApp</button>
      </div>
      <div style="flex:0 0 auto;">
        <button class="btn-red" onclick="limpiarPesajes()">Limpiar todo</button>
      </div>
    </div>

    <div id="vistaMensaje" class="msgbox" style="display:none;"></div>

    <div id="resultado-totales"></div>

    <!-- Panel de errores para tablet -->
    <div id="debug" class="msgbox" style="display:none;"></div>
  </div>

  <script>
    // ========= COMPAT: replaceAll para Safari viejo =========
    (function(){
      if (!String.prototype.replaceAll) {
        String.prototype.replaceAll = function(search, replacement){
          const target = String(this);
          if (search instanceof RegExp) return target.replace(search, replacement);
          const escaped = String(search).replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
          return target.replace(new RegExp(escaped, 'g'), replacement);
        };
      }
    })();

    // ========= DEBUG visible =========
    function showDebug(msg){
      const box = document.getElementById('debug');
      box.style.display = 'block';
      box.textContent = String(msg);
    }
    window.addEventListener('error', (e) => {
      showDebug("‚ùå Error JS:\n" + (e && e.message ? e.message : e));
    });
    window.addEventListener('unhandledrejection', (e) => {
      showDebug("‚ùå Promise rechazado:\n" + (e && e.reason ? (e.reason.message || e.reason) : e));
    });

    // ========= Supabase (IMPORTANTE: NO usar variable llamada "supabase") =========
    const supabaseUrl = 'https://rcegikeiaxptolrduguc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJjZWdpa2VpYXhwdG9scmR1Z3VjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NTMyMDcsImV4cCI6MjA3MTIyOTIwN30.jbPM9F977zeITEmFA_xvVU6SCxlWWVCi3Dx7ZhFfTp8';

    let sb = null;
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      sb = window.supabase.createClient(supabaseUrl, supabaseKey);
    } else {
      showDebug("‚ùå No carg√≥ supabase-js. Revisa conexi√≥n / CDN.");
    }

    function fechaMX() {
      const v = document.getElementById('fecha').value;
      if (v) return new Date(v + 'T00:00:00').toLocaleDateString('es-MX');
      return new Date().toLocaleDateString('es-MX');
    }

    async function guardarViaje() {
      if (!sb) return alert("Supabase no est√° listo (revisa panel de errores).");

      const fecha = document.getElementById('fecha').value;
      if (!fecha) return alert("Selecciona la fecha del viaje");

      // ejemplo
      const datos = {
        "Teleco": [{ kg: 15.8, pzas: 14 }, { kg: 108.5, pzas: 100 }],
        "Cuajo": [{ kg: 40.2, pzas: 40 }]
      };

      const { error } = await sb.from('hoja_viaje').insert([{ fecha, resultados: datos }]);
      if (error) return alert("‚ùå Error al guardar viaje: " + error.message);
      alert("‚úÖ Viaje guardado correctamente.");
    }

    async function generarDocumento() {
      if (!sb) return alert("Supabase no est√° listo (revisa panel de errores).");

      const fecha = document.getElementById('fecha').value;
      const out = document.getElementById('resultado-totales');
      if (!fecha) return alert("Selecciona la fecha del viaje");
      out.textContent = "‚è≥ Cargando totales...";

      const { data, error } = await sb.from('hoja_viaje').select('resultados').eq('fecha', fecha);
      if (error) { out.textContent = "‚ùå Error: " + error.message; return; }
      if (!data || data.length === 0) { out.textContent = "‚ùå No se encontraron registros para esa fecha."; return; }

      const totales = {};
      data.forEach(r => {
        const res = r.resultados || {};
        Object.keys(res).forEach(prod => {
          (res[prod] || []).forEach(p => {
            if (!totales[prod]) totales[prod] = { kg: 0, pzas: 0 };
            totales[prod].kg += Number(p.kg) || 0;
            totales[prod].pzas += Number(p.pzas) || 0;
          });
        });
      });

      let doc = `üìÑ TOTALES DEL D√çA ${fecha}\n\n`;
      Object.entries(totales).forEach(([prod, d]) => {
        doc += `üü¢ ${prod} ‚Üí ${d.kg.toFixed(2)} kg | ${d.pzas} piezas\n`;
      });
      out.textContent = doc;
    }

    // ========= IMPRESI√ìN (m√°s estable en iPad) =========
    function printHtml(html){
      // Intento 1: iframe (mejor para Safari)
      try{
        const iframe = document.createElement('iframe');
        iframe.style.position = 'fixed';
        iframe.style.right = '0';
        iframe.style.bottom = '0';
        iframe.style.width = '0';
        iframe.style.height = '0';
        iframe.style.border = '0';
        document.body.appendChild(iframe);

        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(html);
        doc.close();

        setTimeout(() => {
          try{
            iframe.contentWindow.focus();
            iframe.contentWindow.print();
          } finally {
            setTimeout(() => document.body.removeChild(iframe), 800);
          }
        }, 350);

        return;
      }catch(e){
        // Intento 2: ventana nueva
      }

      const win = window.open('', '_blank');
      if (!win) { alert("Tu tablet bloque√≥ la impresi√≥n (popups). Activa 'permitir ventanas emergentes'."); return; }
      win.document.open();
      win.document.write(html);
      win.document.close();
      win.focus();
      setTimeout(() => win.print(), 350);
    }

    function imprimirSebo80mm() {
      const kg = Number(document.getElementById('seboKg').value || 0);
      if (!kg || kg <= 0) return alert("Ingresa los kilos de sebo.");

      const STORE = "Carnes y V√≠sceras del Centro";
      const fecha = fechaMX();

      const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace}
        #t{width:80mm;padding:2mm}
        h3{margin:0;text-align:center;font-size:14px}
        .c{text-align:center;font-size:11px;margin-top:4px}
        .line{border-top:1px dashed #000;margin:6px 0}
        .big{text-align:center;font-weight:800;font-size:16px}
        .amt{text-align:center;font-weight:900;font-size:20px;margin-top:4px}
        @media print{@page{size:80mm auto;margin:0}}
      </style></head><body>
        <div id="t">
          <h3>${STORE}</h3>
          <div class="c">PAPEL DE SEBO<br>FECHA: ${fecha}</div>
          <div class="line"></div>
          <div class="big">DIO SEBO</div>
          <div class="amt">${kg.toFixed(2)} KG</div>
          <div class="line"></div>
          <div class="c">FIRMA: ____________________________</div>
        </div>
      </body></html>`;

      printHtml(html);
    }

    function imprimirEtiqueta80mm() {
      const texto = (document.getElementById('etiquetaTexto').value || '').trim();
      const copias = Math.max(1, parseInt(document.getElementById('etqCopias').value || '1', 10));
      if (!texto) return alert("Escribe el texto de la etiqueta.");

      const STORE = "Carnes y V√≠sceras del Centro";
      const fecha = fechaMX();

      const safe = escapeHtml(texto).replaceAll('\n','<br>');

      const baseHtml = (body) => `<!DOCTYPE html><html><head><meta charset="utf-8">
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <style>
        body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace}
        #t{width:80mm;padding:2mm}
        .c{text-align:center;font-size:10px}
        .line{border-top:1px dashed #000;margin:6px 0}
        .body{text-align:center;font-weight:900;font-size:18px;line-height:1.15;word-break:break-word}
        @media print{@page{size:80mm auto;margin:0}}
      </style></head><body>${body}</body></html>`;

      let i = 0;
      const doOne = () => {
        const html = baseHtml(`
          <div id="t">
            <div class="c"><b>${STORE}</b><br>FECHA: ${fecha}</div>
            <div class="line"></div>
            <div class="body">${safe}</div>
            <div class="line"></div>
            <div class="c">Etiqueta / Se√±alamiento (${i+1}/${copias})</div>
          </div>
        `);
        printHtml(html);
        i++;
        if (i < copias) setTimeout(doOne, 900);
      };
      doOne();
    }

    function limpiarEtiqueta(){
      document.getElementById('etiquetaTexto').value = '';
      document.getElementById('etqCopias').value = 1;
    }

    // ========= MENSAJES DE PESAJES (KG Y PZAS OPCIONALES) =========
    let pesajes = []; // {producto, kg|null, pzas|null}

    function agregarLinea(){
      const producto = (document.getElementById('prodNombre').value || '').trim();

      const kgRaw = document.getElementById('prodKg').value;
      const pzasRaw = document.getElementById('prodPzas').value;

      const kg = (kgRaw === '') ? null : Number(kgRaw);
      const pzas = (pzasRaw === '') ? null : Number(pzasRaw);

      if (!producto) return alert("Pon el nombre del producto.");

      const kgOk = (kg !== null && kg > 0);
      const pzasOk = (pzas !== null && pzas > 0);
      if (!kgOk && !pzasOk) return alert("Ingresa kilos, piezas o ambos.");

      pesajes.push({
        producto,
        kg: kgOk ? kg : null,
        pzas: pzasOk ? parseInt(pzas,10) : null
      });

      document.getElementById('prodNombre').value = '';
      document.getElementById('prodKg').value = '';
      document.getElementById('prodPzas').value = '';
      renderTabla();
    }

    function eliminarLinea(idx){
      pesajes.splice(idx, 1);
      renderTabla();
    }

    function renderTabla(){
      const tbody = document.getElementById('tablaLineas');
      tbody.innerHTML = '';
      pesajes.forEach((p, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(p.producto)}</td>
          <td>${p.kg ? Number(p.kg).toFixed(2) : ''}</td>
          <td>${p.pzas ? p.pzas : ''}</td>
          <td><button class="btn-red" style="padding:8px 12px;border-radius:8px;" onclick="eliminarLinea(${idx})">Quitar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function generarMensaje(){
      const origen = (document.getElementById('origen').value || '').trim();
      const fecha = fechaMX();

      if (pesajes.length === 0) return alert("Agrega al menos un producto.");
      if (!origen) return alert("Pon el origen / de qui√©n se recibe.");

      let msg = `üì¶ *PESAJE RECIBIDO*\n`;
      msg += `üìÖ Fecha: ${fecha}\n`;
      msg += `üë§ Origen: ${origen}\n\n`;
      msg += `*Detalle:*\n`;

      pesajes.forEach(p => {
        let linea = `‚Ä¢ ${p.producto} ‚Äî `;
        if (p.kg && p.pzas) linea += `${Number(p.kg).toFixed(2)} kg | ${p.pzas} pzas`;
        else if (p.kg) linea += `${Number(p.kg).toFixed(2)} kg`;
        else if (p.pzas) linea += `${p.pzas} pzas`;
        msg += linea + `\n`;
      });

      const box = document.getElementById('vistaMensaje');
      box.style.display = 'block';
      box.textContent = msg;

      return msg;
    }

    async function copiarMensaje(){
      const msg = generarMensaje();
      if (!msg) return;

      try{
        if (!navigator.clipboard || !navigator.clipboard.writeText) throw new Error("Clipboard no disponible");
        await navigator.clipboard.writeText(msg);
        alert("‚úÖ Mensaje copiado.");
      }catch(e){
        alert("En esta tablet no se pudo copiar autom√°tico. Mant√©n presionado el texto y copia manual.");
      }
    }

    function abrirWhatsApp(){
      const msg = generarMensaje();
      if (!msg) return;

      const num = (document.getElementById('whatsNumero').value || '').trim();
      const encoded = encodeURIComponent(msg);

      const url = num
        ? `https://wa.me/${num}?text=${encoded}`
        : `https://wa.me/?text=${encoded}`;

      window.open(url, '_blank');
    }

    function limpiarPesajes(){
      pesajes = [];
      document.getElementById('origen').value = '';
      document.getElementById('whatsNumero').value = '';
      document.getElementById('prodNombre').value = '';
      document.getElementById('prodKg').value = '';
      document.getElementById('prodPzas').value = '';
      document.getElementById('vistaMensaje').style.display = 'none';
      document.getElementById('vistaMensaje').textContent = '';
      renderTabla();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    // Exponer globales
    window.guardarViaje = guardarViaje;
    window.generarDocumento = generarDocumento;
    window.imprimirSebo80mm = imprimirSebo80mm;
    window.imprimirEtiqueta80mm = imprimirEtiqueta80mm;
    window.limpiarEtiqueta = limpiarEtiqueta;

    window.agregarLinea = agregarLinea;
    window.eliminarLinea = eliminarLinea;
    window.generarMensaje = generarMensaje;
    window.copiarMensaje = copiarMensaje;
    window.abrirWhatsApp = abrirWhatsApp;
    window.limpiarPesajes = limpiarPesajes;
  </script>
</body>
</html>

